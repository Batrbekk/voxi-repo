#!KAMAILIO

# Voxi Kamailio Configuration
# SIP Proxy for routing calls to Asterisk

####### Global Parameters #########

debug=2
log_stderror=yes
memdbg=5
memlog=5

children=4
auto_aliases=no

listen=udp:0.0.0.0:5060
listen=tcp:0.0.0.0:5060

####### Modules Section ########

loadmodule "tm.so"
loadmodule "sl.so"
loadmodule "rr.so"
loadmodule "pv.so"
loadmodule "maxfwd.so"
loadmodule "textops.so"
loadmodule "siputils.so"
loadmodule "xlog.so"
loadmodule "sanity.so"
loadmodule "dispatcher.so"

####### Routing Logic ########

# Main SIP request routing logic
request_route {
    # per request initial checks
    route(REQINIT);

    # CANCEL processing
    if (is_method("CANCEL")) {
        if (t_check_trans()) {
            route(RELAY);
        }
        exit;
    }

    # handle retransmissions
    if (!is_method("ACK")) {
        if(t_precheck_trans()) {
            t_check_trans();
            exit;
        }
        t_check_trans();
    }

    # record routing for dialog forming requests
    if (!is_method("REGISTER|MESSAGE")) {
        record_route();
    }

    # handle registrations
    if (is_method("REGISTER")) {
        xlog("L_INFO", "REGISTER from $fu\n");
        sl_send_reply("200", "OK");
        exit;
    }

    if ($rU==$null) {
        # request with no Username in RURI
        sl_send_reply("484","Address Incomplete");
        exit;
    }

    # dispatch to Asterisk
    route(DISPATCH);
}

# Dispatch requests to Asterisk
route[DISPATCH] {
    xlog("L_INFO", "Dispatching call to Asterisk: $ru\n");

    # Set destination to Asterisk
    $du = "sip:asterisk:5061;transport=udp";

    route(RELAY);
}

# Relay route
route[RELAY] {
    if (!t_relay()) {
        sl_reply_error();
    }
    exit;
}

# Per SIP request initial checks
route[REQINIT] {
    if (!mf_process_maxfwd_header("10")) {
        sl_send_reply("483","Too Many Hops");
        exit;
    }

    if(is_method("OPTIONS") && uri==myself && $rU==$null) {
        sl_send_reply("200","Keepalive");
        exit;
    }

    if(!sanity_check("1511", "7")) {
        xlog("Malformed SIP message from $si:$sp\n");
        exit;
    }
}

# Handle replies
onreply_route {
    xlog("L_INFO", "Reply from $si: $rs $rr\n");
}

# Manage failure routing cases
failure_route[MANAGE_FAILURE] {
    if (t_is_canceled()) {
        exit;
    }
}
